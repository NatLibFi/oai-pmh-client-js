---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  - name: npm
    image: plugins/npm
    settings:
      registry: 'https://registry.npmjs.org/'
      token:
        from_secret: npm_token
    when:
      event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - master

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_gpg_key:
        from_secret: gpg_key
---
kind: secret
name: npm_token
data: pgkxKUuPgdYiH8gzM6TCcxRiCIx2WTwZ/ywi2JTfTjdrNHBncsjTGsA9pPUmVYMhSqybY9VpHj3+u9kPBdRtpQ==
---
kind: secret
name: ssh_key
data: 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
---
kind: secret
name: gpg_key
data: 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
---
kind: signature
hmac: 34b5b491e6998561c2e5d188e759d7174f6583edff8c38e78aaff692ffe2e8cd

...
